<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rate Your Visit</title>
  <style>
    :root { --r: 16px; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background: #f6f7fb; color: #111; }
    .wrap { max-width: 820px; margin: 0 auto; padding: 18px; }
    .card { background: #fff; border-radius: 18px; padding: 18px; box-shadow: 0 8px 26px rgba(0,0,0,.06); }
    .top { display: flex; gap: 14px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .badge { display:inline-flex; align-items:center; gap:10px; padding: 10px 12px; border-radius: 999px; background:#f0f5ff; }
    h1 { font-size: 22px; margin: 0; }
    .sub { margin: 4px 0 0; color:#444; }
    .grid { display: grid; gap: 14px; margin-top: 14px; }
    @media (min-width: 760px){ .grid { grid-template-columns: 1fr 1fr; } }
    .panel { border: 1px solid #e8e8ef; border-radius: 16px; padding: 14px; }
    .panel h2 { font-size: 16px; margin: 0 0 6px; }
    .hint { color:#555; font-size: 13px; margin: 0 0 10px; }
    .stars { display:flex; gap:8px; flex-wrap: wrap; }
    .starbtn {
      border: 1px solid #e5e5ef; background: #fff; border-radius: 14px;
      padding: 10px 12px; font-size: 18px; cursor: pointer;
      transition: transform .05s ease;
    }
    .starbtn:active { transform: scale(.98); }
    .selected { outline: 3px solid #cfe0ff; border-color: #cfe0ff; }
    textarea {
      width: 100%; min-height: 84px; resize: vertical;
      border-radius: 14px; border: 1px solid #e5e5ef; padding: 10px 12px;
      font-size: 14px; box-sizing: border-box;
    }
    .row { display:flex; gap: 10px; flex-wrap: wrap; align-items:center; }
    .btn {
      border: 0; border-radius: 14px; padding: 12px 14px; cursor:pointer;
      font-weight: 600;
    }
    .primary { background: #111; color:#fff; }
    .ghost { background: #f2f2f6; color:#111; }
    .msg { margin-top: 10px; font-size: 14px; color:#0b6; }
    .err { color:#b00; }
    .small { font-size: 12px; color:#666; }
    .dash { margin-top: 14px; display:none; }
    .dashgrid { display:grid; gap: 12px; }
    @media (min-width: 760px){ .dashgrid { grid-template-columns: repeat(3,1fr); } }
    .kpi { padding: 12px; border-radius: 16px; background:#fafafe; border:1px solid #eee; }
    .kpi .v { font-size: 22px; font-weight: 800; margin-top: 2px; }
    .footer { margin-top: 14px; color:#666; font-size: 12px; text-align:center; }
    .pill { padding: 8px 10px; border-radius: 999px; background:#f6fff6; border:1px solid #ddf3dd; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1 id="shopTitle">Rate your visit</h1>
          <p class="sub" id="shopSub">It takes less than 20 seconds.</p>
        </div>
        <div class="badge">
          <span class="pill">Support Local • Support Green</span>
        </div>
      </div>

      <div class="grid">
        <div class="panel">
          <h2>1) Rate the service</h2>
          <p class="hint">Staff attitude, speed, helpfulness</p>
          <div class="stars" id="serviceStars"></div>
        </div>

        <div class="panel">
          <h2>2) Rate the business overall</h2>
          <p class="hint">Cleanliness, value, products, overall experience</p>
          <div class="stars" id="businessStars"></div>
        </div>

        <div class="panel" style="grid-column: 1 / -1;">
          <h2>Optional comment</h2>
          <p class="hint">What can we improve? (optional)</p>
          <textarea id="comment" maxlength="200" placeholder="Write a short comment… (max 200 characters)"></textarea>
          <div class="row" style="margin-top:10px;">
            <button class="btn primary" id="submitBtn">Submit</button>
            <button class="btn ghost" id="resetBtn" type="button">Reset</button>
            <span class="small" id="charCount">0/200</span>
          </div>
          <div class="msg" id="msg"></div>
        </div>
      </div>

      <!-- Tiny owner dashboard (toggle with ?admin=1) -->
      <div class="dash" id="dash">
        <h2 style="margin: 12px 0 8px;">Owner Dashboard (Demo)</h2>
        <div class="dashgrid">
          <div class="kpi">
            <div class="small">Total votes</div>
            <div class="v" id="kpiTotal">0</div>
          </div>
          <div class="kpi">
            <div class="small">Avg service rating</div>
            <div class="v" id="kpiService">–</div>
          </div>
          <div class="kpi">
            <div class="small">Avg business rating</div>
            <div class="v" id="kpiBusiness">–</div>
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn ghost" id="clearDataBtn" type="button">Clear demo data</button>
          <span class="small">Tip: open with <b>?admin=1</b> to show dashboard.</span>
        </div>
      </div>

      <div class="footer">Thank you for helping us improve service quality in our local community.</div>
    </div>
  </div>

  <script>
    // --------- Config (optional server endpoint) ----------
    // If later you connect a backend (Google Apps Script, etc.), paste it here.
    // Leave empty for offline/demo mode.
    const ENDPOINT = ""; // e.g. "https://script.google.com/macros/s/XXXXX/exec"

    // --------- Helpers ----------
    const qs = new URLSearchParams(location.search);
    const shopId = qs.get("shopId") || "default-shop";
    const shopName = qs.get("shopName") || "Local Business";
    const isAdmin = qs.get("admin") === "1";

    const storageKey = `ratings:${shopId}`;

    const state = {
      service: 0,
      business: 0
    };

    const el = (id) => document.getElementById(id);

    function setHeader() {
      el("shopTitle").textContent = `Rate your visit: ${shopName}`;
      el("shopSub").textContent = `Shop ID: ${shopId} • It takes less than 20 seconds.`;
    }

    function makeStars(containerId, onPick) {
      const wrap = el(containerId);
      wrap.innerHTML = "";
      for (let i = 1; i <= 5; i++) {
        const b = document.createElement("button");
        b.className = "starbtn";
        b.type = "button";
        b.textContent = "⭐".repeat(i);
        b.setAttribute("aria-label", `${i} stars`);
        b.onclick = () => onPick(i);
        wrap.appendChild(b);
      }
    }

    function highlight(containerId, value) {
      const buttons = el(containerId).querySelectorAll("button");
      buttons.forEach((b, idx) => {
        b.classList.toggle("selected", idx === value - 1);
      });
    }

    function loadData() {
      try {
        return JSON.parse(localStorage.getItem(storageKey) || "[]");
      } catch {
        return [];
      }
    }

    function saveEntry(entry) {
      const data = loadData();
      data.push(entry);
      localStorage.setItem(storageKey, JSON.stringify(data));
    }

    function avg(nums) {
      if (!nums.length) return null;
      const sum = nums.reduce((a,b)=>a+b,0);
      return (sum / nums.length);
    }

    function updateDashboard() {
      const data = loadData();
      el("kpiTotal").textContent = data.length;

      const s = data.map(x => x.service).filter(Boolean);
      const b = data.map(x => x.business).filter(Boolean);

      const as = avg(s);
      const ab = avg(b);

      el("kpiService").textContent = as === null ? "–" : as.toFixed(1) + " / 5";
      el("kpiBusiness").textContent = ab === null ? "–" : ab.toFixed(1) + " / 5";
    }

    async function sendToServer(entry) {
      if (!ENDPOINT) return { ok: true, mode: "offline" };
      const res = await fetch(ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(entry)
      });
      if (!res.ok) throw new Error("Server error");
      return { ok: true, mode: "online" };
    }

    function setMsg(text, isError=false) {
      const m = el("msg");
      m.textContent = text;
      m.className = "msg" + (isError ? " err" : "");
    }

    // --------- Init UI ----------
    setHeader();

    makeStars("serviceStars", (i) => {
      state.service = i;
      highlight("serviceStars", i);
    });

    makeStars("businessStars", (i) => {
      state.business = i;
      highlight("businessStars", i);
    });

    el("comment").addEventListener("input", () => {
      el("charCount").textContent = `${el("comment").value.length}/200`;
    });

    el("resetBtn").onclick = () => {
      state.service = 0; state.business = 0;
      highlight("serviceStars", 0);
      highlight("businessStars", 0);
      el("comment").value = "";
      el("charCount").textContent = "0/200";
      setMsg("");
    };

    el("submitBtn").onclick = async () => {
      if (!state.service || !state.business) {
        setMsg("Please rate both the service and the business overall.", true);
        return;
      }
      const entry = {
        shopId,
        shopName,
        service: state.service,
        business: state.business,
        comment: el("comment").value.trim(),
        timestamp: new Date().toISOString()
      };

      // Always save locally (demo-proof)
      saveEntry(entry);
      updateDashboard();

      setMsg("Submitting…");
      try {
        const r = await sendToServer(entry);
        setMsg(r.mode === "online"
          ? "✅ Thank you! Your feedback was submitted."
          : "✅ Thank you! Your feedback was saved (demo mode).");
      } catch (e) {
        setMsg("✅ Saved locally, but could not submit online (check internet/server).", true);
      }

      // Reset selections after submit
      state.service = 0; state.business = 0;
      highlight("serviceStars", 0);
      highlight("businessStars", 0);
      el("comment").value = "";
      el("charCount").textContent = "0/200";
    };

    // Dashboard (admin)
    if (isAdmin) {
      el("dash").style.display = "block";
      updateDashboard();
      el("clearDataBtn").onclick = () => {
        localStorage.removeItem(storageKey);
        updateDashboard();
        setMsg("Demo data cleared.");
      };
    }
  </script>
</body>
</html>
